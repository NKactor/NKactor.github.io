<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="个人博客"><meta name="keywords" content="python, linux, mysql, django, 前端, css, javascript, html"><title>装饰器、中间件和Session | NKactor</title><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">装饰器、中间件和Session</h1><a id="logo" href="/.">NKactor</a><p class="description">笨鸟先飞，滴水穿石，马上就办</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Arama"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">装饰器、中间件和Session</h1><div class="post-meta"><a href="/2018/12/03/装饰器、中间件和Session/#comments" class="comment-count"></a><p><span class="date">Dec 03, 2018</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><center><strong>装饰器、中间件和Session的使用</strong></center>

<h3 id="一、装饰器"><a href="#一、装饰器" class="headerlink" title="一、装饰器"></a>一、装饰器</h3><h4 id="1-1-什么是装饰器"><a href="#1-1-什么是装饰器" class="headerlink" title="1.1 什么是装饰器"></a>1.1 什么是装饰器</h4><ul>
<li><p>装饰器模式（Decorator Pattern）允许向一个现有的对象添加新的功能，同时又不改变其结构。这种类型的设计模式属于结构型模式，它是作为现有的类的一个包装。</p>
</li>
<li><p>这种模式创建了一个装饰类，用来包装原有的类，并在保持类方法签名完整性的前提下，提供了额外的功能。</p>
</li>
</ul>
<h4 id="1-2-装饰器的三个基本点"><a href="#1-2-装饰器的三个基本点" class="headerlink" title="1.2 装饰器的三个基本点"></a>1.2 装饰器的三个基本点</h4><pre><code>1、外层函数内嵌内层函数
2、外层函数返回内层函数
3、内层函数调用外层函数的参数
</code></pre><p>&emsp;&emsp;例如：<br><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义登录验证的装饰器</span></span><br><span class="line">def is_login(func):</span><br><span class="line">    <span class="comment"># func 就是被装饰的函数（function类型）</span></span><br><span class="line">    def check_status(request):</span><br><span class="line">        <span class="keyword">token</span> = request.COOKIES.<span class="built_in">get</span>(<span class="string">'token'</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">token</span>:</span><br><span class="line">            token_user = TokenUser.objects.<span class="built_in">filter</span>(<span class="keyword">token</span>=<span class="keyword">token</span>).<span class="keyword">first</span>()</span><br><span class="line">            <span class="keyword">if</span> token_user:</span><br><span class="line">                <span class="comment"># 返回func(request)表示继续执行被装饰的函数</span></span><br><span class="line">                <span class="literal">return</span> func(request)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="literal">return</span> HttpResponseRedirect(<span class="string">'/login/'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="literal">return</span> HttpResponseRedirect(<span class="string">'/login/'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="literal">return</span> check_status</span><br></pre></td></tr></table></figure></p>
<p><strong>&emsp;&emsp;注意：</strong>在上面的函数中外层函数的形参func指的是饰器装饰的函数，是一个function对象。return func(request)表示继续执行被装饰函数（如果需要继续执行被装饰函数就应该这样写），由于被装饰的函数有一个形参request，所以需要传入这个request参数，根据具体函数情况而定，也可以其他的执行操作。</p>
<p><strong>&emsp;&emsp; 装饰器优点：</strong>利用装饰器可以替代我们纯手写的登录校验代码，同时装饰器有较高的灵活性，耦合性低，减少代码重复。</p>
<p><strong>&emsp;&emsp; 装饰器缺点：</strong>多层装饰比较复杂。</p>
<h3 id="二、中间件"><a href="#二、中间件" class="headerlink" title="二、中间件"></a>二、中间件</h3><h4 id="2-1-什么是中间件："><a href="#2-1-什么是中间件：" class="headerlink" title="2.1 什么是中间件："></a>2.1 什么是中间件：</h4><p>&emsp;&emsp;面向切面编程AOP中的中间件是一个最好的例子。官方的说法：中间件是一个用来处理Django的请求和响应的框架级别的钩子。它是一个轻量、低级别的插件系统，用于在全局范围内改变Django的输入和输出。</p>
<h4 id="2-2-中间件Middleware描述"><a href="#2-2-中间件Middleware描述" class="headerlink" title="2.2 中间件Middleware描述"></a>2.2 中间件Middleware描述</h4><pre><code>中间件： 
    1. 是一个轻量级的，底层的插件，可以介入Django的请求和响应的过程（面向切面编程)
    2. 中间件的本质就是一个python类
</code></pre><p><strong>&emsp;&emsp;注意：</strong>中间件是帮助我们在视图函数执行之前和执行之后都可以做一些额外的操作，它本质上就是一个自定义类，类中定义了几个方法，Django框架会在请求的特定的时间去执行这些方法。</p>
<h4 id="2-3-中间件中的方法"><a href="#2-3-中间件中的方法" class="headerlink" title="2.3 中间件中的方法"></a>2.3 中间件中的方法</h4><p>&emsp;&emsp; 每个中间j件都是一个独立的类，主要有一下几个方法</p>
<pre><code>1. process_requeest(self, request)
    该方法是在Django接收到request之后，但仍未解析出url以确定运行哪个视图函数view视图函数之前。
2. process_view(self, request, view_func, view_args, view_kwargs)
    执行时机在django执行完request预处理函数并确定待执行的view之后, 但在视图函数view之前
    request: HttpRequest对象
    view_fun: 是django将要调用的视图函数, 是真实的函数对象本身
    view_args: 将传入view的位置参数列表, 不包括request参数
    view_kwargs: 将传入view的字典参数
3. process_response(self, request, response)
    该方法必须返回HttpResponse对象, 可以是原来的, 也可以是修改后的
    调用时机在django执行完view函数并生成response之后, 该中间件能修改response的内容, 常见用途比如压缩内容
    request是request对象
    response是从view中返回的response对象
4. process_exception(self, request, exception)
    默认不主动调用，该方法只有在request处理过程中出了问题并且view函数抛出了一个未捕获的异常才会被调用, 可以用来发送错误通知, 将相关信息输出到日志文件, 或者甚至尝试从错误中自动恢复。
    参数包括request对象, 还有view函数抛出的异常对象exception
    必须返回None或HttpResponse对象
5. process_template_response(self, request, response)
    默认不主动调用，在视图执行render()返回后进行调用，必须返回None或HttpResponse对象
</code></pre><p><strong>&emsp;&emsp;注意：</strong>以上方法的返回值可以是None或一个HttpResponse对象，如果是None，则继续按照django定义的规则向后继续执行，如果是HttpResponse对象，则直接将该对象返回给用户。</p>
<p><strong>&emsp;&emsp; 具体函数解释：</strong></p>
<pre><code>1. process_request()函数
process_request方法中有一个request参数，其表示请求。该方法中可以返回None或不用返回任何参数，或返回HttpResponse对象。如果返回None或不返回任何参数则表示继续执行其余中间件，如果是返回HttpResponse对象则直接返回HttpResponse对象给客户端，而不再执行视图函数。


2. process_response(self, request, response)函数
process_ response方法中两个参数，一个是请求request参数，一个是响应response参数，该response参数就是视图函数返回的HttpResponse对象。
</code></pre><p>&emsp;&emsp; 修改中间件TestMiddlware1和TestMiddlware2，修改代码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestMiddlware1</span><span class="params">(MiddlewareMixin)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        print(<span class="string">'test1 process_request'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_response</span><span class="params">(self, request, response)</span>:</span></span><br><span class="line">        print(<span class="string">'test1 process_response'</span>)</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestMiddlware2</span><span class="params">(MiddlewareMixin)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        print(<span class="string">'test2 process_request'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_response</span><span class="params">(self, request, response)</span>:</span></span><br><span class="line">        print(<span class="string">'test2 process_response'</span>)</span><br><span class="line">        <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp; 访问inde路由地址，在控制台中可以打印如下的内容:</p>
<pre><code>test1 process_request
test2 process_request
index views
test2 process_response
test1 process_response
</code></pre><p>&emsp;&emsp; 从结果中可以发现，中间件的process_request在访问视图函数之前执行，而process_reponse在视图函数之后执行。并且从执行顺序中可以得出以下结论:</p>
<pre><code>1）    多个中间件的process_request的执行顺序是按照在MIDDLEWARE中定义的先后顺序执行的。
2）    多个中间件的process_response的执行顺序是按照MIDDLEWARE中定义的顺序逆序执行的。也就是说第一个中间件的process_request先执行，而第一个中间件的process_response最后执行。
3）    视图函数在process_request之后执行。
4）    视图函数在process_response之前执行。
5）    process_response必须返回响应对象。


3. process_view(self, view_func, view_args, view_kwargs) 讲解及处理流程
</code></pre><p>&emsp;&emsp; 该方法接收四个参数:</p>
<pre><code>请求request
view_func: 即将被执行的函数
view_args：传递给视图函数的列表参数
view_kwargs：传递给视图函数的字典参数
</code></pre><p>&emsp;&emsp; 修改中间件TestMiddlware1和TestMiddlware2，修改代码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestMiddlware1</span><span class="params">(MiddlewareMixin)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        print(<span class="string">'test1 process_request'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_response</span><span class="params">(self, request, response)</span>:</span></span><br><span class="line">        print(<span class="string">'test1 process_response'</span>)</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_view</span><span class="params">(self, request, view_func, view_args, view_kwargs)</span>:</span></span><br><span class="line">        print(<span class="string">'test1 process_view'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestMiddlware2</span><span class="params">(MiddlewareMixin)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        print(<span class="string">'test2 process_request'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_response</span><span class="params">(self, request, response)</span>:</span></span><br><span class="line">        print(<span class="string">'test2 process_response'</span>)</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_view</span><span class="params">(self, request, view_func, view_args, view_kwargs)</span>:</span></span><br><span class="line">        print(<span class="string">'test2 process_view'</span>)</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp; 访问index路由地址，在控制台中可以打印如下的内容:</p>
<pre><code>test1 process_request
test2 process_request
test1 process_view
test2 process_view
index views
test2 process_response
test1 process_response
</code></pre><p>&emsp;&emsp; 从结果中可以发现，中间件中的process_view方法在视图函数之前执行，在process_request方法之后执行，process_view执行的顺序按照MIDDLEWARE中定义中间件的顺序执行的。并且从执行的结果中可以得出以下结论:</p>
<pre><code>1）    process_request执行后才执行process_view
2）    视图函数在process_view方法执行后执行
3）    process_view方法在process_response方法之后执行，并且执行的顺序按照MIDDLEWARE中定义中间件的顺序执行

4. process_template_response(self, request, response) 讲解及处理流程
该方法中接收两个参数，一个是请求request，一个是响应response，该响应response由视图函数产生。process_template_response方法默认是不执行的，只会在视图函数返回对象有一个render方法时才会被调用。
</code></pre><p>&emsp;&emsp; 修改index视图函数</p>
<pre><code>rep = HttpResponse()
rep.render = index_render
return rep
</code></pre><p>&emsp;&emsp; 修改中间件TestMiddlware1和TestMiddlware2，修改代码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestMiddlware1</span><span class="params">(MiddlewareMixin)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        print(<span class="string">'test1 process_request'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_response</span><span class="params">(self, request, response)</span>:</span></span><br><span class="line">        print(<span class="string">'test1 process_response'</span>)</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_view</span><span class="params">(self, request, view_func, view_args, view_kwargs)</span>:</span></span><br><span class="line">        print(<span class="string">'test1 process_view'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_exception</span><span class="params">(self, request, exception)</span>:</span></span><br><span class="line">        print(<span class="string">'test1 process_except'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_template_response</span><span class="params">(self, request, response)</span>:</span></span><br><span class="line">        print(<span class="string">'test1 process_template_response'</span>)</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestMiddlware2</span><span class="params">(MiddlewareMixin)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        print(<span class="string">'test2 process_request'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_response</span><span class="params">(self, request, response)</span>:</span></span><br><span class="line">        print(<span class="string">'test2 process_response'</span>)</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_view</span><span class="params">(self, request, view_func, view_args, view_kwargs)</span>:</span></span><br><span class="line">        print(<span class="string">'test2 process_view'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_exception</span><span class="params">(self, request, exception)</span>:</span></span><br><span class="line">        print(<span class="string">'test2 process_except'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_template_response</span><span class="params">(self, request, response)</span>:</span></span><br><span class="line">        print(<span class="string">'test2 process_template_response'</span>)</span><br><span class="line">        <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp; 访问index路由地址，在控制台中可以打印如下的内容:</p>
<pre><code>test1 process_request
test2 process_request
test1 process_view
test2 process_view
index views
test2 process_template_response
test1 process_template_response
test2 process_response
test1 process_response
</code></pre><p>&emsp;&emsp; 从结果中可以得出以下结论:</p>
<pre><code>1）    process_template_response在视图函数执行完后。并且执行的顺序按照MIDDLEWARE中定义中间件的顺序逆序执行。
2）    process_response方法是最后执行的，并且执行的顺序按照MIDDLEWARE中定义中间件的顺序逆序执行。

5. process_exception(self, request, exception) 讲解及处理流程
该方法中接收两个参数，一个是请求request，一个是异常exception，该exception是视图函数产生的异常Exception对象。process_exception方法默认是不执行的，只会在视图函数出现异常的情况才会执行。
</code></pre><p>&emsp;&emsp; 修改index视图函数，使得index方法抛出一个异常:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'GET'</span>:</span><br><span class="line">        print(<span class="string">'index views'</span>)</span><br><span class="line">        <span class="number">1</span>/<span class="number">0</span></span><br><span class="line">    	<span class="keyword">return</span> HttpResponse(<span class="string">'我是index方法'</span>)</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp; 修改中间件TestMiddlware1和TestMiddlware2，修改代码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestMiddlware1</span><span class="params">(MiddlewareMixin)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        print(<span class="string">'test1 process_request'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_response</span><span class="params">(self, request, response)</span>:</span></span><br><span class="line">        print(<span class="string">'test1 process_response'</span>)</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_view</span><span class="params">(self, request, view_func, view_args, view_kwargs)</span>:</span></span><br><span class="line">        print(<span class="string">'test1 process_view'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_exception</span><span class="params">(self, request, exception)</span>:</span></span><br><span class="line">        print(<span class="string">'test1 process_except'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestMiddlware2</span><span class="params">(MiddlewareMixin)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        print(<span class="string">'test2 process_request'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_response</span><span class="params">(self, request, response)</span>:</span></span><br><span class="line">        print(<span class="string">'test2 process_response'</span>)</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_view</span><span class="params">(self, request, view_func, view_args, view_kwargs)</span>:</span></span><br><span class="line">        print(<span class="string">'test2 process_view'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_exception</span><span class="params">(self, request, exception)</span>:</span></span><br><span class="line">        print(<span class="string">'test2 process_except'</span>)</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp; 访问index路由地址，在控制台中可以打印如下的内容:</p>
<pre><code>test1 process_request
test2 process_request
test1 process_view
test2 process_view
index views
test2 process_except
test1 process_except
test2 process_response
test1 process_response
</code></pre><p>&emsp;&emsp; 从结果中可以得出以下结论:</p>
<pre><code>1）    process_request最先执行。并且执行的顺序按照MIDDLEWARE中定义中间件的顺序执行。
2）    process_view在视图函数之前执行，并且执行的顺序按照MIDDLEWARE中定义中间件的顺序执行。
3）    视图函数在process_view方法执行后执行，在process_exception方法之前执行。
4）    process_exception方法在process_response方法之前执行，并且执行的顺序按照MIDDLEWARE中定义中间件的顺序逆序执行。
5）    process_response方法是最后执行的，并且执行的顺序按照MIDDLEWARE中定义中间件的顺序逆序执行。
</code></pre><h3 id="三、cookie-session实现登录的保持"><a href="#三、cookie-session实现登录的保持" class="headerlink" title="三、cookie + session实现登录的保持"></a>三、cookie + session实现登录的保持</h3><p>&emsp;&emsp; 在为引入装饰器和中间件之前，对于登录状态的保持我们都是自己在需要进行登录校验的视图函数中添加登录校验代码，采用的是cookie的形式。这样会产生大量的重复代码，所以我们引入中间和装饰器，减少代码重复。</p>
<pre><code>由于cookie这种保持登录状态存在安全隐患，所以下面我们才有session和csrf进行登录状态保持

session指的是回话，是指当用户请求时服务端和客户端会建立一个回话连接，当用户发送其他请求时会携带服务器端返回的session_key（一串随机数）来发送请求，服务端去Django维持的Django_session数据库表中查询是否有该key所对应的数据，有则允许访问，否则不能访问。
</code></pre><p>&emsp;&emsp; 使用request.session向session中写入session值</p>
<pre><code># 使用session实现登录操作
# 1. 向cookie中设置session值，value为随机字符串
# 2. 向Django_session表中存入sessionid值

    request.session[&apos;user_id&apos;] = user.id
</code></pre><p>&emsp;&emsp; 这里设置的session值一般为主键，因为我们可以通过主键获取到一个user对象，方便与我们后面取值，推荐使用。</p>
<p>&emsp;&emsp; 结合中间件或者装饰器我们可以减少跟多的代码，下面是采用中间件进行登录校验</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginStatusMiddleware</span><span class="params">(MiddlewareMixin)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="comment"># 在访问登录和注册页面的时候都不需要进行登录校验</span></span><br><span class="line">        <span class="keyword">if</span> request.path <span class="keyword">in</span> [<span class="string">'/login/'</span>, <span class="string">'redister'</span>]:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 这个函数的return可写可不写，推荐不写</span></span><br><span class="line">        <span class="comment"># 登录校验，当访问需要登录才能访问的页面时就需要进行登录校验，登录了就能访问，未登录就不能访问</span></span><br><span class="line">        <span class="comment"># token校验</span></span><br><span class="line">        <span class="comment"># token = request.COOKIES.get('token')</span></span><br><span class="line">        <span class="comment"># if token:</span></span><br><span class="line">        <span class="comment">#     token_user = TokenUser.objects.filter(token=token).first()</span></span><br><span class="line">        <span class="comment">#     if not token_user:</span></span><br><span class="line">        <span class="comment">#         return HttpResponseRedirect('/login/')</span></span><br><span class="line">        <span class="comment"># else:</span></span><br><span class="line">        <span class="comment">#     return HttpResponseRedirect('/login/')</span></span><br><span class="line">        <span class="comment"># session校验</span></span><br><span class="line">        <span class="comment"># 1. 获取cookie中的值，</span></span><br><span class="line">        <span class="comment"># 2. 查询Django_session表中的session_key字段</span></span><br><span class="line">        <span class="comment"># 查询大数据，则获取session_data中存入的键值对</span></span><br><span class="line"></span><br><span class="line">        user_id = request.session.get(<span class="string">'user_id'</span>)</span><br><span class="line">        <span class="keyword">if</span> user_id:</span><br><span class="line">            user = MyUser.objects.get(pk=user_id)</span><br><span class="line">            request.user = user</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> HttpResponseRedirect(<span class="string">'/login/'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_response</span><span class="params">(self, request, response)</span>:</span></span><br><span class="line">        print(<span class="string">'reponse'</span>)</span><br><span class="line">        <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp; 在上面定义的中间件类中我们通过request.sessions.get(‘user_id’)进行session校验，如果用户登录就能在Django_session表中获取到相应的session数据,这样一句就相当于我们上面写的token检验等功能，但是代码量更少，可读性跟高。装饰器同样的方式即可。</p>
<h3 id="四、session的常用操作"><a href="#四、session的常用操作" class="headerlink" title="四、session的常用操作"></a>四、session的常用操作</h3><h4 id="1-设置session"><a href="#1-设置session" class="headerlink" title="1. 设置session"></a>1. 设置session</h4><pre><code>session是键值对的形式存储的，所以可以用以下方法设置session
request.session[&apos;键名&apos;] = value
如： request.session[&apos;user_id&apos;] = user.id
</code></pre><h4 id="2-获取session值"><a href="#2-获取session值" class="headerlink" title="2. 获取session值"></a>2. 获取session值</h4><pre><code>通过request.session.get()获取session值
格式： request.session.get(key)
如： request.session.get(&apos;user_id&apos;)
</code></pre><h4 id="3-删除session值"><a href="#3-删除session值" class="headerlink" title="3. 删除session值"></a>3. 删除session值</h4><pre><code>删除Django_session表中的值
# 仅仅只删除Django_session表中的数据
request.session.delete(request.session.session_key)
# 删除客户端和服务端session表中的值
# request.session.flush()
</code></pre></div><div class="tags"><a href="/tags/Django/">Django</a></div><div class="post-share"><div class="bdsharebuttonbox"><span style="float:left;line-height: 28px;height: 28px;font-size:16px;font-weight:blod">分享到：</span><a href="#" data-cmd="more" class="bds_more"></a><a href="#" data-cmd="mshare" title="分享到一键分享" class="bds_mshare"></a><a href="#" data-cmd="fbook" title="分享到Facebook" class="bds_fbook"></a><a href="#" data-cmd="twi" title="分享到Twitter" class="bds_twi"></a><a href="#" data-cmd="linkedin" title="分享到linkedin" class="bds_linkedin"></a><a href="#" data-cmd="youdao" title="分享到有道云笔记" class="bds_youdao"></a><a href="#" data-cmd="evernotecn" title="分享到印象笔记" class="bds_evernotecn"></a><a href="#" data-cmd="weixin" title="分享到微信" class="bds_weixin"></a><a href="#" data-cmd="qzone" title="分享到QQ空间" class="bds_qzone"></a><a href="#" data-cmd="tsina" title="分享到新浪微博" class="bds_tsina"></a></div></div><div class="post-nav"><a href="/2018/12/10/rest-framework总结/" class="pre">rest_framework总结</a><a href="/2018/11/30/cookie的使用/" class="next">cookie的使用</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#一、装饰器"><span class="toc-text">一、装饰器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-什么是装饰器"><span class="toc-text">1.1 什么是装饰器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-装饰器的三个基本点"><span class="toc-text">1.2 装饰器的三个基本点</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#二、中间件"><span class="toc-text">二、中间件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-什么是中间件："><span class="toc-text">2.1 什么是中间件：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-中间件Middleware描述"><span class="toc-text">2.2 中间件Middleware描述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-中间件中的方法"><span class="toc-text">2.3 中间件中的方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#三、cookie-session实现登录的保持"><span class="toc-text">三、cookie + session实现登录的保持</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#四、session的常用操作"><span class="toc-text">四、session的常用操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-设置session"><span class="toc-text">1. 设置session</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-获取session值"><span class="toc-text">2. 获取session值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-删除session值"><span class="toc-text">3. 删除session值</span></a></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/12/15/centOS与Nginx与uWsgi部署Django项目/">centOS7+Nginx+uWsgi部署Django项目</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/10/rest-framework总结/">rest_framework总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/03/装饰器、中间件和Session/">装饰器、中间件和Session</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/30/cookie的使用/">cookie的使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/29/模板基础/">模板基础</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/29/模型关系之一对多/">模型关系之一对多</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/28/ORM查询数据操作/">ORM查询数据操作</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/27/认识Django模型/">认识Django模型</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/27/初始Django/">初始Django</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/Django/" style="font-size: 15px;">Django</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="https://www.jianshu.com/u/08d01ad78918" title="简书" target="_blank">简书</a><ul></ul><a href="https://github.com/NKactor/NKactor.github.io" title="GitHub" target="_blank">GitHub</a><ul></ul><a href="https://gitee.com/nkactor/events" title="Gitee" target="_blank">Gitee</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Baidu Site Haritası</a> |  <a href="/atom.xml">订阅</a> |  <a href="/about/">关于</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p><span> Copyright &copy;<a href="/." rel="nofollow">不知名的小演员.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","weixin","tsina","qzone","linkedin","fbook","twi","print","renren","sqq","evernotecn","bdysc","tqq","tqf","bdxc","kaixin001","tieba","douban","bdhome","thx","ibaidu","meilishuo","mogujie","diandian","huaban","duitang","hx","fx","youdao","sdo","qingbiji","people","xinhua","mail","isohu","yaolan","wealink","ty","iguba","h163","copy"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"]}};with(document)0[(getElementsByTagName('head')[0]||head).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script></body></html>